<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ingredients | Smart Food Waste Predictor</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #fef9f0, #fff7e6);
            min-height: 100vh;
        }

        .card {
            border-radius: 20px;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(200, 160, 90, 0.25);
        }

        .card-header {
            background: linear-gradient(90deg, #22c55e, #f59e0b);
            color: #fff;
            border-radius: 20px 20px 0 0;
        }

        .btn-primary {
            background: linear-gradient(90deg, #22c55e, #f59e0b);
            border: none;
        }

        .btn-primary:hover {
            filter: brightness(1.05);
        }

        .table th {
            font-weight: 600;
        }
    </style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg bg-white shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-bold" href="{{ url_for('dashboard') }}">
            Smart Waste Predictor
        </a>

        <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item">
                <a class="nav-link fw-semibold" href="{{ url_for('dashboard') }}">Dashboard</a>
            </li>

            <li class="nav-item">
                <a class="nav-link fw-semibold active" href="{{ url_for('admin_ingredients') }}">
                    Ingredients
                </a>
            </li>

            <li class="nav-item">
                <a class="nav-link fw-semibold" href="{{ url_for('manage_staff') }}">
                    Manage Staff
                </a>
            </li>

            <li class="nav-item">
                <a class="nav-link fw-semibold text-danger" href="{{ url_for('logout') }}">
                    Logout
                </a>
            </li>
        </ul>
    </div>
</nav>

<!-- CONTENT -->
<div class="container my-5">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center px-4 py-3">
            <h4 class="mb-0 fw-bold">Ingredients</h4>
            <button class="btn btn-light fw-semibold" data-bs-toggle="modal" data-bs-target="#addModal">
                + Add Ingredient
            </button>
        </div>

        <div class="card-body p-4">
            <table class="table table-hover align-middle" id="ingredientsTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Category</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% for ingredient in ingredients %}
                    <tr id="row-{{ ingredient.id }}">
                        <td class="name">{{ ingredient.name }}</td>
                        <td class="category">{{ ingredient.category }}</td>
                        <td class="text-end">
                            <!-- UPDATED EDIT BUTTON -->
                            <button class="btn btn-sm btn-outline-primary edit-btn"
                                    data-id="{{ ingredient.id }}"
                                    data-name="{{ ingredient.name }}"
                                    data-category="{{ ingredient.category }}">
                                Edit
                            </button>

                            <button class="btn btn-sm btn-outline-danger"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deleteIngredientModal"
                                    data-ingredient-id="{{ ingredient.id }}"
                                    data-ingredient-name="{{ ingredient.name }}">
                                Delete
                            </button>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ADD MODAL -->
<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content" id="addForm">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Add Ingredient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Name</label>
                    <input type="text" class="form-control" name="name" required>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Category</label>
                    <select class="form-select" name="category" required>
                        <option value="">Select category</option>
                        <option>Vegetable</option>
                        <option>Fruit</option>
                        <option>Spice</option>
                        <option>Meat</option>
                        <option>Dairy</option>
                        <option>Other</option>
                    </select>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary w-100">Add Ingredient</button>
            </div>
        </form>
    </div>
</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content" id="editForm">
            <input type="hidden" name="id">

            <div class="modal-header">
                <h5 class="modal-title fw-bold">Edit Ingredient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Name</label>
                    <input type="text" class="form-control" name="name" required>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Category</label>
                    <select class="form-select" name="category" required>
                        <option>Vegetable</option>
                        <option>Fruit</option>
                        <option>Spice</option>
                        <option>Meat</option>
                        <option>Dairy</option>
                        <option>Other</option>
                    </select>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary w-100">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- DELETE CONFIRM MODAL -->
<div class="modal fade" id="deleteIngredientModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content" method="POST" id="deleteIngredientForm">
            <div class="modal-header">
                <h5 class="modal-title text-danger">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                Are you sure you want to delete <strong id="deleteIngredientName"></strong>?
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger">Yes, Delete</button>
            </div>
        </form>
    </div>
</div>

<!-- TOASTS -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="toastContainer"></div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>

<script>
    // Initialize DataTable
    $(document).ready(function () {
        $("#ingredientsTable").DataTable({
            pageLength: 5,
            lengthChange: false,
            ordering: true,
            searching: true
        });
    });

    // Toast function
    function showToast(message, type = "success") {
        const toastId = `toast-${Date.now()}`;
        const toastHTML = `
            <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        document.getElementById("toastContainer").insertAdjacentHTML("beforeend", toastHTML);
        const toastEl = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

    // -----------------------
    // ADD Ingredient (AJAX)
    // -----------------------
    document.getElementById("addForm").addEventListener("submit", async function(e){
        e.preventDefault();

        const form = e.target;
        const name = form.name.value.trim();
        const category = form.category.value;

        const res = await fetch("/admin/ingredients/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, category })
        });

        if (res.status === 201) {
            const data = await res.json();
            const newIngredient = data.ingredient;

            addRowToTable(newIngredient);

            const modal = bootstrap.Modal.getInstance(document.getElementById("addModal"));
            modal.hide();

            form.reset();
            showToast("Ingredient added successfully", "success");
        } else {
            const error = await res.json();
            showToast(error.error || "Failed to add ingredient", "danger");
        }
    });

    // -----------------------
    // EDIT Ingredient (works now)
    // -----------------------
    document.addEventListener("click", function(e) {
        if (e.target.classList.contains("edit-btn")) {
            const id = e.target.getAttribute("data-id");
            const name = e.target.getAttribute("data-name");
            const category = e.target.getAttribute("data-category");

            const modal = new bootstrap.Modal(document.getElementById("editModal"));
            const form = document.getElementById("editForm");

            form.id.value = id;
            form.name.value = name;
            form.category.value = category;

            modal.show();
        }
    });

    document.getElementById("editForm").addEventListener("submit", async function(e){
        e.preventDefault();

        const form = e.target;
        const id = form.id.value;
        const name = form.name.value.trim();
        const category = form.category.value;

        const res = await fetch(`/admin/ingredients/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, category })
        });

        if (res.ok) {
            updateRowInTable(id, name, category);

            const modal = bootstrap.Modal.getInstance(document.getElementById("editModal"));
            modal.hide();

            showToast("Ingredient updated successfully", "success");
        } else {
            const error = await res.json();
            showToast(error.error || "Failed to update ingredient", "danger");
        }
    });

    // -----------------------
    // DELETE Ingredient
    // -----------------------
    const deleteIngredientModal = document.getElementById("deleteIngredientModal");
    deleteIngredientModal.addEventListener("show.bs.modal", event => {
        const button = event.relatedTarget;
        const ingredientId = button.getAttribute("data-ingredient-id");
        const ingredientName = button.getAttribute("data-ingredient-name");

        document.getElementById("deleteIngredientName").innerText = ingredientName;
        document.getElementById("deleteIngredientForm").action = `/admin/ingredients/${ingredientId}`;
    });

    document.getElementById("deleteIngredientForm").addEventListener("submit", async function(e){
        e.preventDefault();

        const actionUrl = e.target.action;

        const res = await fetch(actionUrl, { method: "DELETE" });

        if (res.ok) {
            const ingredientId = actionUrl.split("/").pop();
            document.getElementById(`row-${ingredientId}`).remove();

            const modal = bootstrap.Modal.getInstance(document.getElementById("deleteIngredientModal"));
            modal.hide();

            showToast("Ingredient deleted successfully", "success");
        } else {
            const error = await res.json();
            showToast(error.error || "Failed to delete ingredient", "danger");
        }
    });

    // -----------------------
    // Helpers (DOM updates)
    // -----------------------
    function addRowToTable(ingredient) {
        const table = $("#ingredientsTable").DataTable();

        table.row.add([
            ingredient.name,
            ingredient.category,
            `<div class="text-end">
                <button class="btn btn-sm btn-outline-primary edit-btn me-1"
                        data-id="${ingredient.id}"
                        data-name="${ingredient.name}"
                        data-category="${ingredient.category}">
                    Edit
                </button>
                <button class="btn btn-sm btn-outline-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteIngredientModal"
                        data-ingredient-id="${ingredient.id}"
                        data-ingredient-name="${ingredient.name}">
                    Delete
                </button>
            </div>`
        ])
            .node().id = `row-${ingredient.id}`;

        table.draw(false);
    }

    function updateRowInTable(id, name, category) {
        const table = $("#ingredientsTable").DataTable();
        const row = document.getElementById(`row-${id}`);
        const rowIndex = table.row(row).index();

        table.row(rowIndex).data([
            name,
            category,
            `<div class="text-end">
                <button class="btn btn-sm btn-outline-primary edit-btn me-1"
                        data-id="${id}"
                        data-name="${name}"
                        data-category="${category}">
                    Edit
                </button>
                <button class="btn btn-sm btn-outline-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteIngredientModal"
                        data-ingredient-id="${id}"
                        data-ingredient-name="${name}">
                    Delete
                </button>
            </div>`
        ]).draw(false);

    }
</script>

</body>
</html>
